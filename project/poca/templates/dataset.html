{% extends "base.html" %}


{% block pageheading %}
Data.gov.uk
{% endblock %}

{% block optional_head %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='stylesheets/jquery.dataTables.min.css')}}">
<script src="{{ url_for('static', filename='javascripts/vendor/jquery.dataTables.min.js')}}" type="text/javascript"></script>

{% endblock %}

{% block content %}

<h1 class="heading-xlarge" style='margin-bottom:0;'>
    {{dataset.title}}

    <span style='float:right; color: #dedede;'>
          {{ publisher.title }}
    </span>
</h1>

<hr/>
Prelude
<hr/>

<div id="tabs-container">
    <ul class="tabs-menu">
        <li class="active-tab">
            <i class="fa fa-list">
              <span class="visuallyhidden">Data</span>
            </i>

          <a href="#listview">
            Data
          </a>
        </li>
        {% if _has_geo %}
        <li>
              <i class="fa fa-map-marker">
                  <span class="visuallyhidden">Map</span>
               </i>

            <a href="#mapview">
              Map</a>
        </li>
        {% endif %}
        <li>
              <i class="fa fa-map-marker">
                  <span class="visuallyhidden">Download</span>
               </i>

            <a href="#download">Download</a>
        </li>
        <li>
              <i class="fa fa-map-marker">
                  <span class="visuallyhidden">Metadata</span>
               </i>

            <a href="#metadata">Metadata</a>
        </li>
    </ul>
    <div class="clearfix"></div>

    <div class="tab grid-row">
        <div id="listview" class="tab-content" style="display:block; ">
            <div class="grid-row">
                <!--
                <div class="column-one-quarter">
                    Facets
                </div>
                -->
                <div class="xcolumn-three-quarter" style="min-height: 500px;">
                    <table id="datatable" class="display" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    {% for col in _columns %}
                                    <th>{{col}}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tfoot>
                                <tr>
                                    {% for col in _columns %}
                                    <th>{{col}}</th>
                                    {% endfor %}
                                </tr>
                            </tfoot>
                        </table>

                </div>
            </div>
        </div>

        {% if _has_geo %}
        <div id="mapview" class="tab-content" style="display:block; display:none;">
            <div class="grid-row">
                <div class="column-one-quarter">
                    Facets
                </div>

                <div class="column-three-quarter">
                     <div id="map" class="map" style="width: 100%; height: 600px;">
                      <div id="popup" class="ol-popup">
                        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                        <div id="popup-content"></div>
                      </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div id="download" class="tab-content" style="display:block; ">
            <div class="grid-row">
                <h1 class="heading-small">Download the entire dataset</h1>

                <a href="">CSV</a>
                {% if _has_geo %}
                  <a href="">GeoJSON</a>
                {% endif %}

                <h1 class="heading-small">Download current view</h1>

                <a href="">CSV</a>
                {% if _has_geo %}
                  <a href="">GeoJSON</a>
                {% endif %}

            </div>
          </div>
    </div>

        <div id="metadata" class="tab-content" style="display:block; ">
            <div class="grid-row">
            </div>
          </div>
    </div>
</div>



<script>
    var map;
    var map_loaded = false;

    (function($) {
        $(".tabs-menu a").click(function(event) {
            event.preventDefault();
            $(this).parent().addClass("active-tab");
            $(this).parent().siblings().removeClass("active-tab");
            var tab = $(this).attr("href");
            $(".tab-content").not(tab).css("display", "none");
            $(tab).show();
            // We don't want to keep focus because 'yellow box'.
            $(this).blur();
            {% if _has_geo %}
            if (event.target.hash == "#mapview" && !map_loaded) {
              setup_map();
            }
            {% endif %}
        });

    function setup_map(){

var popup = $('#popup')[0];
      var popup_content = $('#popup-content');
      $('#popup-closer').click(function () {
        overlay.setPosition(undefined);
        return false;
      });
      var overlay = new ol.Overlay({
        element: popup,
        autoPan: true,
        autoPanAnimation: {
          duration: 250
        }
      });

        map = new ol.Map({
            target: 'map',
            layers: [
              new ol.layer.Tile({
                  source: new ol.source.OSM()
              })
            ],
            view: new ol.View({
                center: new ol.proj.fromLonLat([-3.5360, 54.5781]),
                zoom: 5.8
            }),
            overlays: [overlay]
        });

         map.on('singleclick', function(evt) {
                var feature = map.forEachFeatureAtPixel(evt.pixel,
                  function(feature, layer) {
                    return feature;
                  });
                if(feature) {
                  content = feature.get('content');
                  popup_content.html('<p>' + content + '</p>');
                  var coordinate = feature.getGeometry().getCoordinates();
                  overlay.setPosition(coordinate);
                }
              });

        map_loaded = true;

        setTimeout(load_map_data, 100);
    }

    function load_map_data() {
         $.ajax({
                url: "{{dataset.name}}/geo",
                dataType: "json"
         }).done(function(data) {
            var vectorSource = new ol.source.Vector({});

            $.each(data.points, function(idx, value){
                var p = new ol.geom.Point(ol.proj.fromLonLat([parseFloat(value.lng), parseFloat(value.lat)]) )
                 var iconFeature = new ol.Feature({
                          geometry: p,
                           name: value.name,
                           content: "<strong>" + value.name + "</strong>"
                        });
                 vectorSource.addFeature(iconFeature);
            });

            var iconStyle = new ol.style.Style({
              image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
                anchor: [0.5, 1.0],
                anchorXUnits: 'fraction',
                anchorYUnits: 'fraction',
                opacity: 0.75,
                src: '/static/images/icons/icon-locator.png'
              }))
            });

            var vectorLayer = new ol.layer.Vector({
                source: vectorSource,
                style: iconStyle
              });
             map.addLayer(vectorLayer);
        })
    }


$('#datatable').DataTable( {
    serverSide: true,
    processing: true,
    {% if q %}
    search: {
        search: "{{q}}"
    },
    {% endif %}
    scrollX: true,
    columns: [
        {% for col in _columns %}
            { "data": "{{col}}" }
            {% if not loop.last %}, {% endif%}
        {% endfor %}
    ],
    ajax: {
        url: '/dataset/{{dataset.name}}/data',
        type: "POST"
    }
} );

    })(jQuery);


    </script>

{% endblock %}